name: Node.js CI/CD

on:
    push:
        branches:
            - main

jobs:
    build:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [14.x, 16.x, 18.x]

        steps:
        -   name: checkout code
            uses: actions/checkout@v2

        -   name: Set up Docker Buildx
            uses: docker/setup-buildx-action@v2
            
        -   name: Build Docker image
            run: |
                docker build -t your-image-name .
            
        -   name: Log in to Docker Hub
            uses: docker/login-action@v2
            with:
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}

        -   name: Push Docker image
            run: |
                  docker push your-image-name
                
    
    deploy:
        runs-on: ubuntu-latest
        needs: build

        steps:
        -   name: Deploy Docker image to server
            run: |
                ssh -o StrictHostKeyChecking=no -i ${{ secrets.SSH_PRIVATE_KEY }} user@your-server << 'EOF'
                    docker pull your-image-name  # Pull the latest Docker image
                    docker stop your-container-name || true  # Stop the old container if it exists
                    docker rm your-container-name || true  # Remove the old container if it exists
                    docker run -d --name your-container-name -p 80:3000 your-image-name  # Run the new container
                EOF
